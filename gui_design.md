# VRChatイベントカレンダー入力支援ツール GUI 設計書

## 1. 概要

### 1.1 目的
VRChatイベントカレンダー入力支援ツールの利用にあたり、CLI と `config.json` 直接編集のみだと操作ハードルが高いため、
以下を実現する GUI を提供する。

- `config.json` の編集・保存をフォーム形式で行える
- `create_profile.exe` / `autofill.exe` の実行をボタン操作で行える
- 実行状態・ログを画面上で確認できる

### 1.2 対象ユーザー
- Windows 上で本ツールを使う一般ユーザー
- JSON やコマンドライン操作に不慣れなイベント主催者

### 1.3 前提
- OS: Windows 10 以降
- Python 3.10+（開発・配布形態に応じて exe 化想定）
- 既存の `config.json` / `create_profile.exe` / `autofill.exe` と同一フォルダ内に GUI 実行ファイルを配置


## 2. 画面構成

### 2.1 全体構造
1 ウィンドウ内でタブ切り替えで以下を表示する構成とする。

- 入力内容: イベント基本情報 + 詳細設定（ジャンル、参加条件、備考、海外向け告知など）
- 実行 / ログ: プロファイル作成 / 自動入力実行、ログ表示
- おまけ: 変数 A〜E とテンプレート 5 個を使ったテキスト生成・コピー用の簡易ツール

- ウィンドウ全体
  - 初期サイズはおおよそ 1200x1000 ピクセル程度の見やすい大きさとする
  - 背景はごく薄い水色ベースのパステル調で、ボタン等は少し濃い水色でアクセントを付ける
  - 標準フォントは日本語表示に適したフォント（Yu Gothic UI）をベースフォントとして全体に適用する
  - 実行ファイルと同じフォルダ配下に `favicon.ico` / `image.png` が存在する場合、ウィンドウアイコンとヘッダー画像として利用する

また、ウィンドウ上部に簡単な「使い方」説明テキストを表示する。説明テキストは複数行で表示し、改行とインデントによりステップ形式で案内する。

### 2.2 入力内容タブレイアウト（タブ:「入力内容」）

- ヘッダー
  - タイトル（ウィンドウタイトル）: `VRChatイベントカレンダー入力支援ツール`
  - 使い方の簡単な説明文を上部に表示

- 設定ファイル操作
  - 設定ファイルパス欄
    - 現在使用中の設定ファイルパスをテキストボックスに表示・編集できる
    - 初回起動時は `form_utils.get_config_path()` が指す `config.json` を自動的に参照し、存在すれば読み込む
  - 「参照...」ボタン
    - ファイルダイアログから JSON 設定ファイルを選択し、パス欄に反映する
    - 選択したファイルをただちに読み込んでフォームへ反映する
  - 「入力内容保存」ボタン
    - フォーム内容を JSON として保存する
    - 保存先はファイルダイアログで選択（既存の設定ファイルを上書き保存することも、新規ファイルとして保存することも可能）

- 入力フォーム（基本情報）
  - ラベルとテキスト入力/コンボボックスを縦に並べる
  - 各項目は `config.json` と 1:1 対応

| UIラベル | 対応キー | UI種別 |
|----------|----------|--------|
| フォームURL | form_url | テキスト入力（編集可能） |
| イベント名 | event_name | テキスト入力 |
| Android対応可否 | android_support | ドロップダウン (`PC` / `PC/android` / `android only`) |
| 開始日 | start_date | テキスト入力（`YYYYMMDD`、空欄=当日） |
| 開始時刻 | start_hour / start_minute | テキスト入力（1つの `hh:mm` フィールド。全角数字・全角コロンも許容し、内部で時・分に分解して保存） |
| 終了日 | end_date | テキスト入力（`YYYYMMDD`、空欄=当日） |
| 終了時刻 | end_hour / end_minute | テキスト入力（1つの `hh:mm` フィールド。開始時刻と同様に内部で時・分に分解して保存） |
| イベント主催者 | event_host | テキスト入力 |

GUI 上では開始時刻・終了時刻はそれぞれ 1 つのテキスト入力欄（`hh:mm` 形式、全角数字・全角コロンも許容）から入力し、内部的に `start_hour` / `start_minute` などに分解して保存する。

- 入力フォーム（詳細設定）
  - 入力内容タブ内の下部に、複数のテキストエリアとチェックボックスをまとめて配置する

- イベントジャンル
  - 対応キー: `genres`（配列）
  - UI: 複数のチェックボックス
  - 初期候補（チェックボックス項目）:
    - `アバター試着会`
    - `改変アバター交流会`
    - `その他交流会`
    - `VR飲み会`
    - `店舗系イベント`
    - `音楽系イベント`
    - `学術系イベント`
    - `ロールプレイ`
    - `初心者向けイベント`
    - `定期イベント`

- イベント内容
  - 対応キー: `event_content`
  - UI: 複数行テキストエリア

- 参加条件
  - 対応キー: `participation_conditions`
  - UI: 複数行テキストエリア

- 参加方法
  - 対応キー: `participation_method`
  - UI: 複数行テキストエリア

- 備考
  - 対応キー: `remarks`
  - UI: 複数行テキストエリア（高さは 1 行分程度に抑えた簡易欄）

- 海外向け告知
  - 対応キー: `overseas_announcement`
  - UI: チェックボックス（ON で `true`）

- メールアドレスを返信表示に記録
  - 対応キー: `record_the_email_address_to_reply`
  - UI: チェックボックス
    - 常に ON 固定（無効化されておりユーザーは変更不可）

- X 告知文
  - 対応キー: `x_announcement`
  - UI: 複数行テキストエリア

### 2.3 実行画面レイアウト（タブ:「実行 / ログ」）

- 実行設定
  - `Chrome 起動状態チェック` の説明テキスト
    - 「実行前に Chrome をすべて閉じてください」

- 実行ボタン
  - `プロファイル作成 (create_profile)` ボタン
    - `create_profile.exe` をサブプロセス実行
  - `フォーム自動入力 (autofill)` ボタン
    - `autofill.exe`（または `autofill.py`）をサブプロセス実行
  - 実行前自動保存
    - いずれの実行ボタンも、押下時に現在のフォーム内容をバリデーションしたうえで、指定された設定ファイルパスに自動保存してからサブプロセスを起動する

- ログ表示領域
  - マルチラインテキストボックス（スクロール付き、読取専用）
  - 最新ログを下部に追記

- ステータス表示
  - ステータスラベル
    - 例: `待機中`, `プロファイル作成中...`, `自動入力実行中...`, `完了`, `エラー`
  - 進行状況を表示するインジケータ（プログレスバー or スピナー）

### 2.4 おまけタブレイアウト（タブ:「おまけ」）

- 目的
  - よく使う告知文や定型テキストを、変数 A〜E を差し込んだテンプレートとして管理し、ワンクリックで展開・コピーできるようにする。
  - 入力内容タブとは独立した「テキストお役立ちツール」として提供する。

- レイアウト概要
  - 1 段目: 変数入力欄（A〜E）
    - "A", "B", "C", "D", "E" の 5 つのラベル + テキスト入力欄を横一列または 2 行構成で配置。
    - 各入力欄は自由入力（1 行のテキスト）で、GUI を閉じるまで保持される。
    - 必要に応じて `config.json` と連携させる場合は、後述のキーにマッピングして保存・復元する（初期段階では GUI 起動中のみ保持でも可）。

  - 2 段目以降: テンプレートブロック × 5
    - ブロックは縦方向に 5 つ並べる（スクロール可能）。
    - 各ブロックの構成:
      - タイトル入力欄（1 行のテキスト）
      - 補足入力欄
        - 任意の URL やメモ等を記載するための小さなテキストエリア（高さ 1 行分程度）。
        - 補足欄の内容をクリップボードへコピーするための「クリップボードにコピー」ボタンを併設する。
      - 本文テンプレート用テキストエリア（複数行）
        - 任意の文章を入力可能。
        - `{A}`, `{B}`, `{C}`, `{D}`, `{E}` のようなプレースホルダで変数を指定できる。
      - 本文テキストエリア下部に「上書き保存」ボタン
        - 現在のタイトル・本文・補足を保存（`config.json` の対応キーに保存）。
      - 出力テキスト欄
        - 変数および予約変数を展開した結果を表示するテキストエリア（読み取り専用想定）。
        - 脇に「クリップボードにコピー」ボタンを配置し、展開済みテキストをクリップボードへコピーできるようにする。

- 変数とテンプレートの仕様
  - 変数 A〜E
    - プレースホルダ名: `{A}`, `{B}`, `{C}`, `{D}`, `{E}`。
    - 1 段目のテキスト入力欄に入力された値で置き換える。
    - 未入力の場合は空文字として扱う。
  - テンプレートブロック
    - ブロック番号 1〜5 を内部的に持つ。
    - 各ブロックごとに「タイトル」「本文テンプレート」「出力テキスト」を独立して管理。
    - 上書き保存ボタン押下時、必要であれば `config.json` 上の `extras.templates[0..4]` のような構造に保存し、GUI 再起動後も復元できるようにする設計とする（詳細は 3.4 参照）。


## 3. 機能仕様

### 3.1 config.json 読み込み・保存

- 読み込み
  - デフォルトのパスは `form_utils.get_config_path()` が返す `config.json` を想定
  - 初回起動時に `config.json` が存在すれば自動読み込みしてフォームへ反映
    - 「参照...」ボタンで任意の JSON ファイルをファイルダイアログから選択し、そのパスを `ConfigManager.config_path` として保持・読み込みする
    - 選択・入力されたファイルパスは `ConfigManager.config_path` に保持され、以後の保存・読み込みの対象となる
  - ファイルが存在しない場合
    - 警告ダイアログを表示
  - JSON パースエラー時
    - エラーメッセージをダイアログ表示

- 保存
  - 各フォーム値から JSON オブジェクトを構築してバリデーションを実施
  - 「入力内容保存」ボタン押下時に、ファイルダイアログで保存先を選択
    - 既存の設定ファイルを上書き保存することも、新規 JSON ファイルとして保存することも可能
  - 実行タブの各ボタン押下時には、ユーザー操作なしで現在の設定ファイルパスへ自動保存（上書き）を行ったうえで実行処理を起動する
  - `config.json` の構造（抜粋）
    - 既存のキーに加え、おまけタブ用の情報を `extras` にまとめて保存する。
    - 例:
      ```json
      {
        "form_url": "...",
        "event_name": "...",
        "start_date": "20260201",
        "...": "...",
        "extras": {
          "variables": {
            "A": "任意の文字列",
            "B": "...",
            "C": "...",
            "D": "...",
            "E": "..."
          },
          "templates": [
            { "title": "テンプレ1", "body": "{A} さん、{TODAY} のイベントです", "notes": "任意の補足" },
            { "title": "テンプレ2", "body": "...", "notes": "..." },
            { "title": "テンプレ3", "body": "...", "notes": "..." },
            { "title": "テンプレ4", "body": "...", "notes": "..." },
            { "title": "テンプレ5", "body": "...", "notes": "..." }
          ]
        }
      }
      ```
    - `extras` は省略可能。存在しない場合は GUI 起動時にデフォルト値（空欄の変数・テンプレート）で初期化する。

### 3.2 バリデーション

- 必須項目
  - `form_url`, `event_name`, `start_hour`, `start_minute`, `end_hour`, `end_minute`, `event_host`, `event_content`
  - 上記必須項目が未入力の場合はメッセージを表示し保存・実行をブロック
  - `genres`, `participation_conditions`, `participation_method`, `remarks`, `x_announcement` などその他の項目は任意入力としつつ、適宜入力を推奨する

- 日付
  - `start_date`, `end_date` が空欄の場合は、実行側（autofill.py）と同様に当日日付を利用する仕様に合わせる
  - GUI 上は空欄許可（プレースホルダで「空欄=当日」説明）
  - 基本入力フォーマットは `YYYYMMDD` とするが、互換性のため `YYYY/MM/DD` および `YYYY-MM-DD` も内部的に受け付ける

- 時刻
  - GUI 上は 1 つの `hh:mm` 形式テキスト（全角数字・全角コロンも可）から開始/終了時刻を入力する
  - 入力文字列は内部で半角に正規化したうえで `start_hour` / `start_minute`、`end_hour` / `end_minute` に分解する
  - `start_hour` / `end_hour` は 0〜23、`start_minute` / `end_minute` は 0〜59 の範囲チェックを行う

- その他
  - `genres` は 1 つ以上選択されていることを推奨（警告のみでも可）

### 3.3 実行機能

- プロファイル作成ボタン
  - 通常は `create_profile` モジュールの `main` 関数を別スレッド（または別プロセス）で起動する
  - exe 化した配布物では、必要に応じて `create_profile.exe` をラップして起動してもよい
  - 起動に失敗した場合、エラーダイアログ + ログ
  - 実行中はボタンを無効化（連打防止）

- フォーム自動入力ボタン
  - 通常は `autofill` モジュールの `main` 関数を別スレッド（または別プロセス）で起動する
  - exe 化した配布物では、必要に応じて `autofill.exe` をラップして起動してもよい
  - Chrome プロセスの起動有無を自動チェックする処理は行わず、画面上部の注意書きによりユーザーに手動で全てのウィンドウを閉じてもらう運用とする
  - 実行中はボタンを無効化

- サブプロセスへの設定ファイル引き渡し
  - 子プロセスには環境変数 `VRC_EVENT_CONFIG_PATH` を通じて現在の設定ファイルパスを渡す
  - `form_utils.get_config_path()` はこの環境変数を優先して参照するため、GUI から指定した設定ファイルをそのまま自動入力処理側で利用できる

- ログ取得
  - 実行処理からの標準出力 / 標準エラー、もしくはロガー経由のメッセージを逐次受け取り、ログエリアに表示
  - 受信にはスレッドセーフなキューなどを用い、GUI スレッド側では一定間隔でポーリングして追記する
  - 重要なメッセージ（`自動入力完了` など）は強調表示（色やプレフィックス）

### 3.4 おまけ機能

- 変数管理
  - 変数 A〜E は GUI 起動中は常に最新値を保持し、`config.json` の `extras.variables` と連携する。
    - GUI 起動時:
      - `extras.variables` が存在すれば、その値を A〜E の初期値として反映する。
      - 存在しなければ、A〜E は空文字で初期化する。
    - 「入力内容保存」ボタン押下時:
      - 現在の A〜E の値を `extras.variables` として保存する。
    - 構造: `extras.variables`: `{ "A": "...", "B": "...", "C": "...", "D": "...", "E": "..." }`

- テンプレート保存・復元
  - 各テンプレートブロックは以下の情報を持つ:
    - `title`: テンプレートのタイトル
    - `body`: 変数プレースホルダを含む本文テンプレート
    - `notes`: テンプレートごとの補足テキスト（リンクやメモなど任意の文字列）
  - 上書き保存ボタン押下時の挙動:
    - 現在の `title` / `body` / `notes` を内部状態および `config.json` の `extras.templates` に保存する。
    - 例:
      ```json
      "extras": {
        "templates": [
          { "title": "テンプレ1", "body": "{A} さん、こんにちは", "notes": "任意の補足" },
          { "title": "テンプレ2", "body": "...", "notes": "..." },
          ...
        ]
      }
      ```
  - GUI 起動時に `extras.templates` が存在すれば読み込み、各ブロックへ反映する。存在しない場合は空のテンプレート 5 個で初期化する。

- 変数展開と出力テキスト
  - 展開ロジック:
    - 各ブロックに対し、本文テンプレート内のプレースホルダを次の優先順位で置換する:
      1. 予約変数（後述）
      2. ユーザー変数 `{A}`〜`{E}`（1 段目の入力値）
    - 置換結果を出力テキスト欄に表示する。
    - 変数変更時またはテンプレート変更時に自動で再計算されるリアルタイム更新、もしくは「更新」ボタンでの手動更新を想定（実装時に UI の重さを見て調整）。
  - コピー操作:
    - 各ブロックの「出力テキスト欄」に対して「クリップボードにコピー」ボタンを提供し、展開済みテキストをクリップボードへコピーする。
    - 補足欄にも「クリップボードにコピー」ボタンを用意し、補足テキストをコピーできるようにする。本文テンプレート自体には専用コピー ボタンを設けず、通常のテキスト選択・コピー操作で対応する。

- 予約変数
  - テンプレート本文中で使用できる、日付やイベント情報を自動で埋め込むためのプレースホルダを用意する。
  - 形式はいずれも `{NAME}` で表記し、ユーザー変数 A〜E とは別名前にする（A〜E はユーザー専用）。
  - 想定する予約変数例:
    - `{TODAY}`: 「本日の日付」。GUI 実行時点の日付を `YYYY/MM/DD` 形式で展開する。
    - `{TOMORROW}`: 「翌日の日付」。`YYYY/MM/DD` 形式で展開する。
    - `{EVENT_NAME}`: `config.json` の `event_name` を展開する（未設定の場合は空文字）。
    - `{START_DATE}`: `start_date` を展開する。
      - `start_date` が空欄の場合は当日の日付を用い、それを `MM/DD` 形式に整形して展開する。
      - `YYYYMMDD` / `YYYY/MM/DD` / `YYYY-MM-DD` のいずれでも正しく解釈し、内部的には `YYYYMMDD` に正規化したうえで、テンプレート展開時には年なしの `MM/DD` として表示する。
    - `{END_DATE}`: `end_date` を展開する。
      - `end_date` が空欄の場合は `start_date`（それも空欄の場合は当日）を用い、`MM/DD` 形式に整形して展開する。
    - `{HOST}`: `event_host` を展開する。
    - `{START_TIME}`: 開始時間を `HH:MM` 形式で展開する。開始時刻が未入力の場合は空文字。
    - `{END_TIME}`: 終了時間を `HH:MM` 形式で展開する。終了時刻が未入力の場合は空文字。
  - 予約変数はユーザーの A〜E 変数より優先して評価され、同名の A〜E は定義できない（A〜E 以外の名前を使うことで衝突を避ける）。


## 4. 技術設計（PySide6）

### 4.1 GUI フレームワーク（採用方針）

- 採用フレームワーク: PySide6 (Qt for Python)
  - クロスプラットフォームで見た目がリッチ
  - レイアウト管理が柔軟（QGridLayout, QFormLayout など）
  - Qt Designer / `.ui` ファイルの利用も視野に入る
  - 将来的な拡張や複数ウィンドウ化にも対応しやすい

- 主な利用モジュール
  - `PySide6.QtWidgets`: `QMainWindow`, `QWidget`, `QTabWidget`, `QScrollArea`, `QLabel`, `QLineEdit`, `QComboBox`, `QCheckBox`, `QTextEdit`, `QPushButton`, `QProgressBar` など
  - `PySide6.QtGui`: `QIcon`, `QFont` など
  - `PySide6.QtCore`: `Qt`, `Signal`, `Slot`, `QThread`, `QTimer` など

### 4.2 モジュール構成（PySide6 実装）

- `gui_design.py`
  - PySide6 ベースの画面定義・レイアウトを担う
  - `QMainWindow` を継承した `MainWindow` クラスを提供
  - 構成:
    - ウィンドウ全体: `QMainWindow`
      - 中央ウィジェット: `QWidget` + `QVBoxLayout`
      - 上部ヘッダー: 画像表示 + 簡易な使い方説明（`QLabel`）
      - メイン領域: `QTabWidget`（「入力内容」「実行 / ログ」「おまけ」の 3 タブ）
    - 「入力内容」タブ:
      - `QScrollArea` + `QWidget` + `QVBoxLayout` でスクロール可能なフォームエリアを構成
      - 設定ファイルパス行: `QLineEdit` + 「参照...」ボタン + 「入力内容保存」ボタン
      - 基本情報フォーム: `QFormLayout` で `QLineEdit` / `QComboBox` を縦並びに配置
      - 詳細設定:
        - ジャンル: `QCheckBox` を `QGridLayout` で複数並べる
        - 複数行テキスト: `QTextEdit` を利用（イベント内容 / 参加条件 / 参加方法 / 備考 / X 告知文）
        - 海外向け告知, メールアドレス記録: `QCheckBox`
    - 「実行 / ログ」タブ:
      - 上部に説明テキスト（`QLabel`）
      - 実行ボタン: 「プロファイル作成」「フォーム自動入力」の `QPushButton`
      - ログ表示: `QTextEdit`（読み取り専用）
      - ステータスラベル + `QProgressBar` またはインジケータ
    - 「おまけ」タブ:
      - 変数 A〜E 入力欄: `QLineEdit` を横並びまたは 2 行構成で配置
      - テンプレートブロック ×5:
        - タイトル: `QLineEdit`
        - 補足: 小さめの `QTextEdit` と「クリップボードにコピー」ボタン
        - 本文テンプレート: `QTextEdit`（下部に「上書き保存」ボタン）
        - 出力テキスト: `QTextEdit`（読み取り専用）+「クリップボードにコピー」ボタン
  - ロジックとは疎結合にするため、各 UI 操作からは Signal を発行し、外側（`gui_main.py`）で処理を受ける設計とする。
    - 例:
      - 設定ファイル選択要求: `configFileSelectRequested`
      - 設定保存要求: `configSaveRequested(dict)`
      - プロファイル作成要求: `createProfileRequested(dict)`
      - 自動入力要求: `autofillRequested(dict)`
      - おまけタブ関連: `templateSaveRequested(dict)`（テンプレートの保存のみを外側に通知し、コピー操作は MainWindow 内部でクリップボードへ直接書き込む）

- `gui_main.py`
  - アプリケーションのエントリポイント
  - `ConfigManager` による設定ファイルの読み書き
  - 入力値のバリデーション処理（GUI から受け取ったデータを検証）
  - 実行処理（create_profile / autofill）の呼び出しとログ取得
  - `gui_design.MainWindow` を生成し、Signal/Slot を接続して機能を実装
  - 既存の `form_utils.get_config_path` を利用して `config.json` のデフォルトパスを取得
  - サブプロセス実行やログ読み取りは `QThread` または `threading` + `QTimer` で GUI スレッドと分離

- `form_utils.py` / `create_profile.py` / `autofill.py`
  - 既存の CLI 版と共通
  - GUI からは環境変数 `VRC_EVENT_CONFIG_PATH` の設定などを通じて利用

- 将来の責務分割
  - 設定 I/O 専用のクラス/モジュール（例: `gui_config_io.py`）
  - バリデーション専用モジュール（`gui_validation.py`）
  - 実行・ログ取得専用モジュール（`gui_runner.py`）
  - などへの分離を検討する。


## 5. ユーザーフロー

### 5.1 初回利用

1. GUI 起動
2. `config.json` 自動読み込み → フォームに反映（存在する場合）
3. 「入力内容」タブで基本情報・詳細設定を入力
4. 「入力内容保存」ボタンで設定を JSON ファイルとして保存
5. `プロファイル作成` ボタンをクリック
6. Chrome ウィンドウでログイン作業を完了
7. 再度 GUI から `フォーム自動入力` ボタンを押下
8. ログエリアで進行状況と完了メッセージを確認

### 5.2 2回目以降

1. GUI 起動 → 前回利用した設定ファイル（または `config.json`）を自動読み込み（存在する場合）
2. 必要な項目のみ修正 → 「入力内容保存」
3. `フォーム自動入力` ボタンで即実行


## 6. エラー・例外処理方針

- `config.json` が見つからない
  - 「config.json が見つかりません。GUIから新規作成できます。」といった警告ダイアログを表示
  - ユーザーがフォームに入力し、「入力内容保存」で新規 JSON を作成する運用とする

- JSON パースエラー
  - 「config.json の形式が不正です。バックアップを作成し、GUI から再保存してください。」

- サブプロセス起動エラー
  - exe ファイルが存在しない / 実行権限がない場合はダイアログ + ログ

- Chrome 起動中
  - 「Chrome が起動中です。すべてのウィンドウを閉じてから再実行してください。」を表示し実行キャンセル


## 7. 将来拡張

- `config.json` の複数パターン管理（プロファイル切替）
- 直近で使った設定の履歴機能
- GUI から直接、フォームURLのテスト表示（ブラウザ起動）

---

この設計書に基づき、まずは PySide6 ベースで `gui_design.py` / `gui_main.py` を実装する想定とする。